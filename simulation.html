<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Four Simulation</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        table { border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        button { padding: 10px 15px; font-size: 1em; cursor: pointer; margin: 15px 5px 15px 0;} /* Added margin */
        #singleGameLogOutput { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        #singleGameLogOutput pre { background-color: #f8f8f8; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; } /* Style for log output */
        .board-log { font-family: monospace; line-height: 1.2; margin-top: 5px; } /* Style for board in log */
    </style>
</head>
<body>
    <h1>Connect Four AI Simulation</h1>

    <h2>AI vs AI Suite</h2>
    <p>Runs simulations pitting AI at different depths against each other.</p>
    <button id="runSuiteButton">Run AI vs AI Suite</button>

    <h2>Single Game Log</h2>
    <p>Runs one game: AI Depth 5 vs Random (opening center), logging each step.</p>
    <button id="runLogButton">Run Single Game Log (D5 vs Random)</button>

    <div id="simulationResults">
        <!-- AI vs AI Results will be displayed here -->
    </div>

    <div id="singleGameLogOutput">
        <!-- Single Game Log will be displayed here -->
    </div>

    <script src="gameLogic.js"></script>
    <script src="aiLogic.js"></script>
    <script src="simulation.js"></script>
    <script>
        // --- Global variable to store simulation results for log access ---
        let simulationData = {};

        // --- Event Listeners ---

        // Listener for AI vs AI Suite button
        document.getElementById('runSuiteButton').addEventListener('click', async () => {
            // Clear previous results/logs
            document.getElementById('simulationResults').innerHTML = 'Running AI vs AI Suite...';
            document.getElementById('singleGameLogOutput').innerHTML = '';
            try {
                // <<< Store results globally
                simulationData = await runSimulationSuite_AIvsAI(); // Run the suite
            } catch (error) {
                console.error("Error running simulation suite:", error);
                document.getElementById('simulationResults').innerHTML = `<p style="color: red;">Error running simulation suite. Check console.</p>`;
            }
        });

        // Listener for Single Game Log button
        document.getElementById('runLogButton').addEventListener('click', () => {
            // Clear previous results/logs
            document.getElementById('simulationResults').innerHTML = '';
            const logOutputDiv = document.getElementById('singleGameLogOutput');
            logOutputDiv.innerHTML = 'Running Single Game Log...';

            try {
                const { log, winner } = runSingleGameWithLog(5, 3); // Run the logged game

                // Format and display the log
                let logHTML = `<h3>Single Game Log (AI D5 vs Random, P1 Forced Open Col 4)</h3>`;
                log.forEach(entry => {
                    logHTML += `<p><strong>Move ${entry.moveNum}:</strong> ${entry.player} in column ${entry.col}</p>`;
                    // Format board state using actual newline characters
                    let boardStr = entry.board.map(row =>
                        "  " + row.map(cell => cell === EMPTY ? '.' : (cell === PLAYER_PIECE ? 'X' : 'O')).join(' ')
                    ).join('\n'); // Use actual newline character
                    logHTML += `<pre class="board-log">${boardStr}</pre>`;
                });

                // Display result
                let resultMsg = "<strong>Result:</strong> ";
                if (winner === AI_PIECE) resultMsg += `AI (D5) wins`;
                else if (winner === PLAYER_PIECE) resultMsg += 'Random wins';
                else if (winner === null) resultMsg += 'Draw';
                else resultMsg += 'Error';
                logHTML += `<p>${resultMsg}</p>`;

                logOutputDiv.innerHTML = logHTML;

            } catch (error) {
                 console.error("Error running single game log:", error);
                 logOutputDiv.innerHTML = `<p style="color: red;">Error running single game log. Check console.</p>`;
            }
        });

        // --- Function to display AI vs AI game log ---
        function displayAiVsAiLog(matchupKey, gameIndex) {
            console.log(`Displaying log for ${matchupKey}, game ${gameIndex + 1}`);
            const logOutputDiv = document.getElementById('singleGameLogOutput');
            logOutputDiv.innerHTML = ''; // Clear previous log
            document.getElementById('simulationResults').innerHTML = ''; // Clear results table

            if (!simulationData || !simulationData[matchupKey] || !simulationData[matchupKey].gameLogs || gameIndex >= simulationData[matchupKey].gameLogs.length) {
                logOutputDiv.innerHTML = `<p style="color: red;">Log data not found for ${matchupKey}, game ${gameIndex + 1}. Please run the suite first.</p>`;
                return;
            }

            const log = simulationData[matchupKey].gameLogs[gameIndex];
            const matchupInfo = simulationData[matchupKey];
            const title = `AI vs AI Log: Depth ${matchupInfo.depthHigh} vs Depth ${matchupInfo.depthLow} (Game ${gameIndex + 1})`;

            let logHTML = `<h3>${title}</h3>`;
            let winnerPiece = null;

            log.forEach(entry => {
                logHTML += `<p><strong>Move ${entry.moveNum}:</strong> ${entry.player} in column ${entry.col}</p>`;
                if (entry.error) {
                    logHTML += `<p style="color: red;">Error: ${entry.message || 'Unknown error'}</p>`;
                }
                // Format board state using actual newline characters
                let boardStr = entry.board.map(row =>
                    "  " + row.map(cell => cell === EMPTY ? '.' : (cell === PLAYER_PIECE ? 'X' : 'O')).join(' ')
                ).join('\n');
                logHTML += `<pre class="board-log">${boardStr}</pre>`;
            });

            // Determine winner based on the *last* move in the log (if no error)
            const lastMove = log[log.length - 1];
            if (lastMove && !lastMove.error) {
                if (checkWin(lastMove.board, PLAYER_PIECE)) {
                    winnerPiece = PLAYER_PIECE;
                } else if (checkWin(lastMove.board, AI_PIECE)) {
                    winnerPiece = AI_PIECE;
                } else if (isBoardFull(lastMove.board)) {
                    winnerPiece = null; // Draw
                }
            }

            // Display result (inferring winner depth from piece)
            let resultMsg = "<strong>Result:</strong> ";
            if (winnerPiece === PLAYER_PIECE) {
                // Need to know which depth corresponds to PLAYER_PIECE for *this specific game*
                // This info isn't directly in the log, we might need to reconstruct or pass it
                // For now, let's just say Player 1 wins (needs refinement if starting player alternates)
                resultMsg += `Player 1 (Depth ${matchupInfo.depthHigh} or ${matchupInfo.depthLow}) wins`;
            } else if (winnerPiece === AI_PIECE) {
                 resultMsg += `Player 2 (Depth ${matchupInfo.depthHigh} or ${matchupInfo.depthLow}) wins`;
            } else if (winnerPiece === null) {
                resultMsg += 'Draw';
            } else {
                resultMsg += 'Error or Incomplete';
            }
            logHTML += `<p>${resultMsg}</p>`;

            logOutputDiv.innerHTML = logHTML;
        }

    </script>
</body>
</html>